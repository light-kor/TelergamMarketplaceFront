#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ –æ—á–∏—Å—Ç–∫–æ–π –ø–æ—Ä—Ç–∞

echo "üöÄ –ó–∞–ø—É—Å–∫ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞..."

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –ø–æ—Ä—Ç–∞
cleanup_port() {
    local PORT=$1
    echo -e "${YELLOW}–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–∞ $PORT...${NC}"
    
    # –ù–∞—Ö–æ–¥–∏–º –ø—Ä–æ—Ü–µ—Å—Å—ã, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –ø–æ—Ä—Ç
    local PIDS=$(lsof -ti:$PORT 2>/dev/null)
    
    if [ -n "$PIDS" ]; then
        echo -e "${YELLOW}–ù–∞–π–¥–µ–Ω—ã –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É $PORT: $PIDS${NC}"
        echo -e "${YELLOW}–ó–∞–≤–µ—Ä—à–∞—é –ø—Ä–æ—Ü–µ—Å—Å—ã...${NC}"
        kill -9 $PIDS 2>/dev/null
        sleep 1
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å–≤–æ–±–æ–¥–∏–ª—Å—è –ª–∏ –ø–æ—Ä—Ç
        if lsof -ti:$PORT >/dev/null 2>&1; then
            echo -e "${RED}‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –ø–æ—Ä—Ç $PORT${NC}"
            return 1
        else
            echo -e "${GREEN}‚úÖ –ü–æ—Ä—Ç $PORT –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω${NC}"
        fi
    else
        echo -e "${GREEN}‚úÖ –ü–æ—Ä—Ç $PORT —Å–≤–æ–±–æ–¥–µ–Ω${NC}"
    fi
    return 0
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
cleanup_frontend_processes() {
    echo -e "${YELLOW}–ü–æ–∏—Å–∫ —Å—Ç–∞—Ä—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞...${NC}"
    
    # –ù–∞—Ö–æ–¥–∏–º –ø—Ä–æ—Ü–µ—Å—Å—ã vite
    local PIDS=$(ps aux | grep "vite" | grep -v grep | awk '{print $2}')
    
    if [ -n "$PIDS" ]; then
        echo -e "${YELLOW}–ù–∞–π–¥–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞: $PIDS${NC}"
        echo -e "${YELLOW}–ó–∞–≤–µ—Ä—à–∞—é –ø—Ä–æ—Ü–µ—Å—Å—ã...${NC}"
        kill -9 $PIDS 2>/dev/null
        sleep 1
        echo -e "${GREEN}‚úÖ –°—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã${NC}"
    else
        echo -e "${GREEN}‚úÖ –°—Ç–∞—Ä—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ${NC}"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
check_dependencies() {
    echo -e "${YELLOW}–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...${NC}"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ Node.js
    if ! command -v node &> /dev/null; then
        echo -e "${RED}‚ùå Node.js –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
        exit 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ npm
    if ! command -v npm &> /dev/null; then
        echo -e "${RED}‚ùå npm –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
        exit 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ node_modules
    if [ ! -d "node_modules" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  node_modules –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏...${NC}"
        npm install
    fi
    
    echo -e "${GREEN}‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã${NC}"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ .env —Ñ–∞–π–ª–∞
check_env() {
    if [ ! -f ".env" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞—é –∏–∑ .env.example...${NC}"
        if [ -f ".env.example" ]; then
            cp .env.example .env
            echo -e "${GREEN}‚úÖ –§–∞–π–ª .env —Å–æ–∑–¥–∞–Ω${NC}"
        else
            echo -e "${YELLOW}‚ö†Ô∏è  .env.example –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞—é –±–∞–∑–æ–≤—ã–π .env...${NC}"
            echo "VITE_API_URL=http://localhost:3000/api" > .env
        fi
    fi
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞
start_frontend() {
    echo -e "${GREEN}üöÄ –ó–∞–ø—É—Å–∫–∞—é —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥...${NC}"
    npm run dev
}

# –ì–ª–∞–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
main() {
    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–∫—Ä–∏–ø—Ç–∞
    cd "$(dirname "$0")"
    
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}  –ó–∞–ø—É—Å–∫ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∏
    check_dependencies
    check_env
    
    # –û—á–∏—Å—Ç–∫–∞
    cleanup_frontend_processes
    cleanup_port 5173
    
    if [ $? -ne 0 ]; then
        echo -e "${RED}‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ${NC}"
        exit 1
    fi
    
    echo ""
    echo -e "${GREEN}‚úÖ –í—Å—ë –≥–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É${NC}"
    echo -e "${YELLOW}üì± –§—Ä–æ–Ω—Ç–µ–Ω–¥ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞: http://localhost:5173${NC}"
    echo ""
    
    # –ó–∞–ø—É—Å–∫ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
    start_frontend
}

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
trap 'echo -e "\n${YELLOW}–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥...${NC}"; exit 0' INT TERM

# –ó–∞–ø—É—Å–∫
main

